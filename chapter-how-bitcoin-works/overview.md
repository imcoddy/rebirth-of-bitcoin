# 比特币的架构

许多人觉得“比特币”难以理解，与这个概念本身的多义性有关，它笼统地涵盖了从钱、钱包、银行到印钞厂等一整套事物。“比特币”可以指一种货币的计量单位，也可以指一套网络协议或相应的网络系统等，甚至还曾经指过相关网络的客户端软件。为了避免混淆，本书约定，在需要特指区分的时候用小写的 `bitcoin` 指代计量单位，大写的 `Bitcoin` 指代相关的网络协议。

比特币是一个自成一体并不依赖其它的货币系统，它的组成包括以下部分：

## 计量单位

计量单位本质上是一个计量符号，比特币系统中的计量单位是 bitcoin。人们所说的比特币系统有 2100 万的上限，即指这个系统中至多有 21000000 bitcoin。此外，比特币可以分割的最小单位是聪(satoshi)，即 1 bitcoin＝100000000 satoshi。

## 交易转账

比特币的价值就是交易渠道本身。一组新制造出来的比特币提供了把旧的比特币从一方转移到另一方的数学保证。这个安全保证背后的代价是大量的算力。生产这么一个区块是需要消耗大量能源的，所以整个比特币用户群体，奖励那个造币者。

## 透明账本

比特币网络上每个节点都记录了比特币诞生以来的每笔交易的详单，并从中可以推测出每个比特币唯一的属于谁。这样你接受一笔交易时，就能知道别人给你的钱是不是合法的。

由于比特币的交易记录全部都是公开的，哪个地址拥有多少比特币，都是可以查到的。因此，支付方是否拥有足够的比特币，完成这笔交易，这是可以轻易验证的。

问题出在怎么防止其他人，冒用你的名义申报交易。举例来说，有人申报了一笔交易：地址 A 向地址 B 支付10个比特币。我怎么知道这个申报是真的，申报人就是地址 A 的主人？

比特币协议规定，申报交易的时候，除了交易金额，转出比特币的一方还必须提供以下数据。

* 上一笔交易的 Hash（你从哪里得到这些比特币）
* 本次交易双方的地址
* 支付方的公钥
* 支付方的私钥生成的数字签名

验证这笔交易是否属实，需要三步。

* 找到上一笔交易，确认支付方的比特币来源。
* 算出支付方公钥的指纹，确认与支付方的地址一致，从而保证公钥属实。
* 使用公钥去验证数字签名，保证私钥属实。

经过上面三步，就可以认定这笔交易是真实的。

## 比特币是什么？

比特币是一种利用点对点技术实现的电子现金系统，与各国央行来统一管理发行的法定货币不同，它的发行并不需要央行这样的权威机构，比特币允许一笔交易从一个组织直接结算给另外一个组织，省去了权威机构结算的环节，提高了交易和结算的效率，节省了交易的成本，尤其是跨境交易的成本。

一个点对点的在线交易系统如何保证交易的匿名性、正确性、不可篡改性？又是如何防止双重支付和防止作弊和攻击的呢？

下面的章节将通过最通俗的语言为大家解开比特币的神秘面纱，让你从逻辑上理解比特币是如何工作的，让比特币的方方面面清晰地呈现在你的脑海里。

## 比特币本身有什么价值？

简单说，我的理解就是，现在世界上所有的比特币背后都是用运行计算机的能量产生出来的，它们的总价值（到现在一共有大约 12w 组比特币被生产出来，每组 50 个，市场价格大约 7.3 美金一个），应该是少于消耗掉的能源的总市场价值的。不过我想，用于生产比特币的能源大都原本就是不用也被浪费掉的资源。

一个没有中心节点的 “银行” 是怎么让大家信任并工作起来的呢？

答案是，这个 P2P 网络上每个节点都记录了比特币诞生以来的每笔交易的详单，并从中可以推测出每个比特币唯一地属于谁。这样你接受一笔交易时，就能知道别人给你的钱是不是合法的。

从最基本的说起：

每个帐户其实就是一对公私匙，有私匙的人就是帐户的主人。如果 A 要给 B 转一笔钱，A 就把钱的数量加上 B 的公匙，用自己的钥匙签名。而 B 看到这个签名，就可以了解，的确是 A 转给了他如数的比特币。

那么这笔交易需要一个见证人，担保交易发生过。这样，以后 B 想用这笔钱的时候才是合法的。担保人就是整个使用比特币的网络。

A 在发起这笔交易的时候，必须把签过名的交易单尽量地广播到 P2P 网络上，最终会让每个节点都知道这件事。B 从 P2P 网络上不断的收到别人的确认信息。当它收到足够多的确认信息后，就认为 A 的确发出了这条交易单。这以后，B 就可以自由使用这笔钱了。

当 B 使用 A 转给它的钱给 C 时，也会广播给足够多（最终所有人都收到）的人让他们担保。每个担保人只有确信 B 有足够多的钱可以支付的时候才做确认。本质上，比特币 网络并没有记录每一块钱属于谁，它记录的是从诞生起到当前的每一笔交易，并推算出每个帐户里有多少钱。任何人试图确认一个交易单时，它需要确认的是转出帐号上有没有那么多钱。

## 比特币解决了什么问题？

比特币解决的核心问题是，如何避免一笔钱被花两次。

整个帐单序列是一环套一环的。每个人在完整的全局帐单上签上新的一笔的时候，都需要利用前面的信息生成后面的信息。这个帐单序列被称为 chain of blocks 。每个区块里面包含有若干条经过确认并 hash 签名 (难以伪造) 的交易记录。每个区块都和全局表上的上一个区块有关联。每条帐单都会通过 P2P 网络最终被转发给制造新区块的节点上。

这个制造新区块的过程被叫做挖矿，制造新区块就是把最近收到的帐单打包在刚制造的区块里。这个打包的过程即制作的过程，只有极其稀少的几率被制造成功。（你可以理解成把新收到的帐单合在一起，一次成型不可修改，如果制造失败就要再来一次）一旦制造成功，你就把新的区块（被认为是对老的全局区块链的延续）广播出去。

因为是 P2P 网络，可能有许多人都在同时制造新的区块，但有一个排序机制保证只有最优（最难，花费最大计算时间的）的那个新区块被网络群体接受，挂在全局的区块链上。重复一次，整个比特币网络只有一个全局帐单表，每个节点都完整的保存有一份。

这个全局帐单表会越来越大，block 链越来越长，在最新的部分，必然有许多分叉。这是因为 P2P 网络的挖矿过程是分开并行进行的，每条新帐单也不能立刻广播给所有的节点。每个挖矿的节点都有责任把它新收到的，在它认可的老的全局帐单上不存在的帐单，合在他准备制造的新区块中。一旦新区块被制造出来，就立刻广播出去，争取得到更多人的认可。主要是得到那些想挖矿的人的认可，这些人会在这个区块的基础上制造新的区块。

如果 P2P 网络过大，交易帐单不能尽快地广播到全网络，就会出来 P2P 的网络的局部保持有小群体共同认可的一份全局帐单。多个全局帐单的分支同时发展是有可能的。因为每个小群体都可能认为他们看见的那部分更长更有效。但是，只要有人发现另一条分支更长，它就会转换阵营。所以，有一定的可能性，你的帐单被一个小群体接受，但在一段时间后，被更大的阵营抛弃。

不过，算法参数决定了，新的区块产生速度很慢，如果你的帐单被多达 6 个人确认，基本上就保证了它合并到的那份全局帐单，就是 P2P 网络全体认可的。

既然生成新区块费时费力，制造出新区块的几率好象买彩票中大奖，还有那么多人去执行程序计算出新区块呢？答案是，每个制造出新区块的人，都有权力构造一条帐单声明老天给了我 50 比特币。这个规则是被所有比特币用户共同承认的。把制造区块等同于成挖金矿 (mining) 只是一个形象上的比喻。实际上，没有人可以把金子挖出来囤积。每个新区块必须包含全局表上的上一个区块的 hash 值，比特币 网络自我调节难度，让每 10 分钟大约产生一个新区块。如果你 10 分钟内没制造出新的区块，差不多就是说你前面 10 分钟干的活白干了。从最新版的区块继续演算。

所以更恰当的比喻是买彩票。一个每 10 分钟开一次的彩票。你不停的花钱买，10 分钟内开中了就是你的，开不中先买的都作废，然后下一轮。

数学上怎样保证挖矿的过程需要消耗大量的 CPU 时间？并只有很小的几率成功？

这里用到一个叫做 [Hashcash](https://en.wikipedia.org/wiki/Hashcash) 的系统。它最早是为了改善垃圾邮件的问题被发明出来的。

就是给一段特定信息（比如这封 email 是从谁发给谁）加一个特定的 hash 头。这个 hash 头需要大量的 CPU 时间计算出来。发 spam 的人没有那么多 CPU 时间为群发的每一封 email 计算一个符合要求的 hash 头，所以认为有这个合法 hash 头的 email 不太可能是 spam （花了 CPU 时间在上面）

这个算法就是，为你想保护的信息，找到一串数字，附加上去后，使用某种公认的 hash 算法，比如 SHA-2 ，算出一个 hash 值。如果 hash 值由一长串 0 打头（具体多少个决定了难度），那么就成功了。

为一段信息，找到这串数字，在目前来说，除了暴力尝试没有什么好的方法。也就是随机更换数字，换一次就 hash 一次然后进行比对。在一个可以预期的尝试次数后，一般都能找到想找的数字。

每个想挖矿赚比特币的人，不停的从比特币网络上监听信息。如果有人发布了新的合法的区块，他就合并到本地的全局表里。并重置自己的计算过程，从新得到的区块开始。如果有新发布的交易单，也记录下来。不断的把最新的区块的 hash 值、新收到的交易单，自己获得 50 比特币的那条奖励单合并在一起，计算 SHA-256 ，看看结果是否满足条件。一旦满足，就把这个新的区块广播出去。

当足够的人认可它，（以它为基础计算后面的区块），他也就获得了那 50 比特币。

为了匹配比特币的经济规模，所有的 Bitcoin 客户端都被设置成每 210000 个区块，生产新区块的人被认可凭空获得的比特币数量比之前的少一半（如果这个时候他还在包内写上自己获得 50 比特币，其他人不会确认他的这个区块）。这会让比特币的总量增速变缓。新的区块产生的速度是由难度来调节的。这个难度会由 P2P 网络根据最近生产区块的速度自动调节。所以即使日后计算能力增加，也能保证大约 10 分钟一个的速度。

而且，随着生产新区块的收益减少，愿意贡献自己的 CPU 来挖矿的节点也会变少。（如果减少太多，只需要减少难度即可）

最终，P2P 网络不再凭空制造出新的比特币，这个时候制造新的区块的动力是什么呢？那就是交易税。因为没有什么人愿意生产新的区块，发起交易就变的困难。（没有区块可以容纳交易单）希望交易被确认的人可以声明，如果有人制造出新的区块接纳他的交易单，他会支付一小笔交易税给他。当许多人都这么做的时候，制造区块又变的有利可图了。只不过不会再有新的比特币诞生，比特币只是在这些用户之间流通。

总有一些比特币会消失，主要是那些帐号的私匙丢失了，没有任何人可以转移走帐户上的钱。不能流通的货币就不是货币了。但最终比特币总体会达到一个比较大的规模，准确说是 2100 万个。但比特币本身是可以切割的，比如你可以支付给别人 0.01 个比特币。所以比特币本身会升值，总数也一直够用。


比特币的基本原理理解起来并不难，基本概念包括：

交易：对账本状态的改变，如添加一条记录;

区块：记录一段时间内发生的交易和状态，是对当前账本状态的一次共识;

链：由一个个区块按照发生顺序串联而成，是状态变化的日志记录。

分布式数据账本

如果把区块链作为一个状态机，则每次交易就是试图改变一次状态，每次生成区块就是参与者对于其中包括的所有交易改变状态的结果确认。

在实现上，首先假设存在一个分布式的数据记录本(这方面的技术相对成熟)，这个记录本只允许添加、不允许删除。其结构是一个线性的链表，由一个个“区块”串联组成，这也是其名字“区块链”的来源。新的数据要加入，必须放到一个新的区块中来加入。而这个块(以及块里的交易)是否合法，可以通过一些手段快速检验出来。维护节点都可以提议一个新的区块，然而必须经过一定的共识机制来对最终选择的区块达成一致。

发起一项交易后，会广播到网络中并等待确认。网络中的节点会将一些等待确认的交易记录打包在一起(此外还要包括此前区块的哈希值等信息)，组成一个候选区块。然后，试图找到一个 nonce 串放到区块里，使得候选区块的 hash 结果满足一定条件(比如小于某个值)。一旦算出来这个区块在格式上就合法了，就可以进行全网广播。大家拿到提案区块，进行验证，发现确实符合约定条件了，就承认这个区块是一个合法的新区块，被添加到链上。当然，在实现上还会有很多的细节。

比特币的这种基于算力的共识机制被称为 Proof of Work(PoW)。目前，要让 hash 结果满足一定条件并无已知的启发式算法，只能进行暴力尝试。尝试的次数越多，算出来的概率越大。通过调节对 hash 结果的限制，比特币网络控制约 10 分钟平均算出来一个合法区块。算出来的节点将得到区块中所有交易的手续费和协议固定发放的奖励费(目前是每四年减半)，也即俗称的挖矿。

能否进行恶意操作来破坏整个区块链系统或者获取非法利益呢？比如不承认别人的结果，拒绝别人的交易等。实际上，因为系统中存在大量的用户，而且用户默认都只承认他看到的最长的链。只要不超过一半(概率意义上越少肯定越难)的用户协商，最终最长的链将很大概率上是合法的链，而且随着时间增加，这个概率会越大。
